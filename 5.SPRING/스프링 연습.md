### 게시판까지 구현하기

### 1. spring legacy project 생성 및 서버로 테스트하기

### 2. 인코딩 설정 및 테스트하기

* 블로그 참고

### 3. 패키지명  변경

* 패키지명 수정 => controller 패키지
* servlet-context.xml에서 base-package명 수정

### 4. 타일즈 적용 및 테스트하기

* 블로그 참고

### 5. 각종 패키지 생성

* service 패키지
* dao패키지
* vo패키지

### 6. DB 연동

* 블로그 참고
* root-context.xml 파일 설정까지

### 7. DB 연동 테스트

* MemberService 인터페이스 생성

* MemberServiceImp 클래스 생성

  * MemberService 인터페이스를 구현
  * @Service를 추가

* MemberDAO 인터페이스 생성

* MemberMapper.xml에 샘플 코드 추가

  * src/main/resources 폴더에 mappers 폴더를 생성
  * MemberMapper.xml 파일 생성 후 샘플 코드 추가
  * namespace 부분을 현재 프로젝트에 알맞게 수정
  * mapper태그 안에 예제 코드를 삭제

* MemberVO 클래스 생성

  * 테이블 속성과 멤버변수 이름이 같게 생성
  * getter/setter 생성과 toString을 오버라이딩함

* 컨트롤러에 멤버 변수로 MemberService 추가

  * @Autowired 이용

* MemberService에 멤버변수로 MemberDAO 추가

  * @Autowired 이용

* 서버를 재가동하여 에러가 안나는지 테스트

* 컨트롤러/서비스/다오/매퍼에 샘플 코드 추가 및 테스트

  * DB에 샘플 데이터를 추가

  * 컨트롤러 샘플 코드

    * ```java
      @RequestMapping(value= "/")
      public ModelAndView openTilesView(ModelAndView mv) throws Exception{
          mv.setViewName("/main/home");
          //아래 코드는 연동 확인후 지울 코드
          //qwe는 샘플 데이터에 있는 회원아이디
          MemberVO user = memberService.test("qwe");
          System.out.println(user);
          return mv;
      }
      ```

  * 서비스 샘플 코드

    * ```java
      MemberVO test(String id);
      ```

  * 서비스임플 샘플 코드

    * ```java
      @Override
      public MemberVO test(String id) {
          return memberDao.test(id);
      }
      ```

  * 다오 샘플 코드

    * ```java
      MemberVO test(@Param("id")String id);
      ```

  * 매퍼 샘플 코드

    * ```xml
        <select id="test" resultType="kr.green.green.vo.MemberVO">
        	select * from member where me_id = #{id}
        </select>
      ```

  ### 8. 회원가입 기능 구현(비밀번호 암호화 적용)

  * [ github.com/st8324/Docs](http://github.com/st8324/Docs) 참고

  * header.jsp 회원가입 링크 추가
  
  * 컨트롤러에 회원가입 화면을 보여줄수 있는 메소드를 추가
    * /signup에 GET방식
    * 보여줄 화면은 /member/signup.jsp로 설정
    
  * 회원가입 화면파일을 생성. member폴더에 signup.jsp를 생성
    * 회원가입 화면을 구성
    
  * 컨트롤러에 회원가입을 처리하는 메소드를 추가
    * /signup에 POST방식
    * 회원가입이 정상적으로 진행되면 메인페이지(/)로 이동을 시킴
    * 회원가입이 정상적으로 진행되지 않으면 회원가입페이지(/sigup)으로 이동을 시킴
    
  * 컨트롤러에 화면에서 전달한 회원정보를 받아서 확인
    * 매개변수를 추가
    
    * 생일과 관련해서 에러가 발생할 수 있음
    
      * 원인 : 화면에서는 yyyy-mm-dd로 된 문자열을 전송하는데 생일이 Date클래스로 되어 있으면 자동으로 변환이 안됨. String이 Date로 형변환이 안됨.
    
      * 해결방안 : setMe_birth(String date)로 setter를 수정하여 문자열로 된 날짜를 Date로 변환하는 코드를 작성해야 함
    
      * ```java
        public void setMe_birth(String me_birth) {
            SimpleDateFormat format;
            try {
                format = new SimpleDateFormat("yyyy-MM-dd");
                this.me_birth = format.parse(me_birth);
            } catch (ParseException e) {
                e.printStackTrace();
            }
        }
        ```
    
        
    
    * 화면에 input태그/textarea태그/select태그 등에 name을 MemberVO의 매개변수와 일치하게 설정
    
  * 컨트롤러에서 회원정보를 서비스에게 주면서 회원가입하라고 시킴. 
    * 이때 서비스는 회원가입 진행후 가입이 성공했는지 실패했는지 컨트롤러에게 알려줌(리턴타입)
    
  * 서비스에 회원가입 메소드 추가
    * 컨트롤러에서 에러 나는 부분 마우스 호버 create method... 클릭
    
  * 서비스 임플에 회원가입 메소드 추가
    * 서비스임플에서 에러나는 부분 마우스 호버 add unimplemented... 클릭
    
  * 서비스 임플에서 회원가입 기능을 구현
    * 비밀번호 암호화를 함
    * 다오에게 회원가입 정보를 전달하면서 가입하라고 시킴
    
  * 다오에 회원가입 메소드 추가
  
    * 서비스임플에서 에러나는 부분 호버 후 create method... 클릭
    * @Param("이름")을 매개변수 앞에 추가
  
  * 매퍼에 쿼리문 구현
  
    * id에 다오에 추가한 메소드명을 입력
    * 쿼리문 구현
      * 매개변수로 넘어오는 값은 #{}를 이용하고, 넘겨주는 값이 정수나 문자열이 아니면 #{객체명.멤버변수명}으로 호출

### 9. 로그인 기능 구현(Interceptor를 이용한 로그인 유지 적용)

* header.jsp에 링크 추가
* 컨트롤러에서 메소드 추가및 코드 구현
* 로그인 화면 구성
  * form태그 이용
  * name 설정
* 로그인 시도시 컨트롤러에서 회원 정보가 잘 오는지 확인
* 서비스와 서비스 임플에 코드를 구현
  * 비밀번호 암호화를 이용하여 비밀번호를 확인
* 다오에 메소드를 추가
* 매퍼에 쿼리문을 추가
  * resultType 설정 시 오타 조심
* 문서 참고하여 로그인 유지 기능 구현
  * [로그인 유지 문서 참고 링크](https://github.com/st8324/Docs/blob/master/spring%20framework/Interceptor%EB%A5%BC%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20%EC%9C%A0%EC%A0%80%20%EC%A0%95%EB%B3%B4%20%EC%84%B8%EC%85%98%EC%97%90%20%EC%A0%80%EC%9E%A5%ED%95%98%EA%B8%B0.md)

* 로그인 시 화면에서 로그인메뉴와 회원가입 메뉴 안보이게 처리
* 로그인 시 화면에서 로그아웃메뉴 보이도록 처리



### 10. 로그아웃 기능 구현

* 로그아웃 링크 추가
* 컨트롤러에 로그아웃 코드 구현



### 11. 인터셉터를 이용하여 회원만 게시글 등록/수정/삭제가 되도록 처리

* [참고문서링크](https://github.com/st8324/Docs/blob/master/spring%20framework/Interceptor%EB%A5%BC%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20%EA%B6%8C%ED%95%9C%EC%97%90%20%EB%94%B0%EB%A5%B8%20%ED%8E%98%EC%9D%B4%EC%A7%80%20%EC%82%AC%EC%9A%A9%20%EA%B2%B0%EC%A0%95.md)
* 다음 URL에 대하여 회원만 접근하도록 인터셉터를 생성후 처리(MemberInterceptor)
  * /board/register
  * /board/modify
  * /board/detail

### 12. 인터셉터를 이용하여 비회원만 로그인/회원가입이 되도록 처리

* [참고문서링크](https://github.com/st8324/Docs/blob/master/spring%20framework/Interceptor%EB%A5%BC%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20%EA%B6%8C%ED%95%9C%EC%97%90%20%EB%94%B0%EB%A5%B8%20%ED%8E%98%EC%9D%B4%EC%A7%80%20%EC%82%AC%EC%9A%A9%20%EA%B2%B0%EC%A0%95.md)
* 다음 URL에 대하여 로그인하지 않은 비회원만 접근하도록 인터셉터를 생성후 처리(GuestInterceptor)
  * /login
  * /signup

### 13. 게시글 리스트 확인 구현

* URL : /board/list
* 게시글 링크 등록
* 보드 컨트롤러, 보드 서비스, 보드서비스임플,보드다오,보드매퍼, 보드VO 추가
  * 컨트롤러 클래스로 생성 후 @Controller 추가
  * 서비스는 인터페이스로 생성 후 implements를 이용하여 서비스 구현
  * 서비스 임플은 클래스로 생성 후 @Service 추가
  * 다오는 인터페이스로 생성
  * 매퍼는 xml로 생성 후 namespace를 BoardDAO로 설정
  * Autowired를 이용하여 멤버변수 설정
    * 컨트롤러에 멤버변수로 서비스를 설정
    * 서비스임플에 멤버변수로 다오를 설정
* 컨트롤러에 게시글 리스트 확인하는 메소드 등록 및 구현
* 서비스와 서비스 임플에 게시글 가져오는 메소드 등록 및 구현
* 다오와 매퍼에 게시글 가져오는 메소드 등록 및 쿼리문 작성
* 확인

### 14. 게시글 상세 확인

* /board/detail
* 게시글 리스트에서 게시글 제목 링크를 수정
* 컨트롤러에서 해당 메소드 처리하는 코드 등록 및 구현
* 서비스/서비스 임플에서 메소드 등록 및 구현
* 다오/매퍼에서 메소드 등록 및 구현
* 게시글 상세 화면 구현



### 15. 게시글 등록 

* /board/register
* 게시글 리스트에서 게시글 등록 버튼을 추가
  * 등록 버튼 클릭하면 /board/register로 이동
* 게시글 등록 화면 구현(get)
  * 컨트롤러에 해당 URL을 담당하는 메소드 등록 및 코드 구현
  * 기본 등록화면 jsp 생성
  * 게시글 등록 화면 구현
    * form태그 이용
      * method는 post로
* 게시글 등록 기능 구현(post)
  * 테스트 시 로그인을 꼭 해야 테스트 가능
  * 컨트롤러에 게시글 등록하는 메소드 등록 및 코드 구현
    * 게시글 등록 후 완료되면 /board/list로 이동하도록 처리
    * 화면에서 입력한 게시글이 오는지 확인
    * 로그인한 사용자 정보를 확인
    * 서비스에게 일을 시킴
  * 서비스/ 서비스 임플에 메소드 등록 및 구현
    * 게시글 제목이 있는지 확인
  * 다오/매퍼에 메소드 등록 및 쿼리 구현
    * insert문을 이용

### 16. 게시글 수정

* /board/modify
* 게시글 상세에서 게시글 수정 버튼을 추가
  * 작성자와 로그인한 유저가 같은 경우만 보이도록 작성
* 게시글 수정 화면(get)
  * 컨트롤러에 메소드 등록 및 코드 구현
  * 게시글 수정 화면 jsp 생성
  * 컨트롤러에서 수정할 게시글 번호 확인
  * 컨트롤러에서 회원정보 확인
  * 서비스에게 게시글 가져오라고 시킴
  * 게시글의 작성자와 회원 아이디가 일치하면 수정 화면으로 이동
  * 게시글의 작성자와 회원 아이디가 일치하지 않으면 게시글 상세로 이동
  * 가져온 게시글 정보를 게시글 수정화면에 출력
    * form태그 이용
      * method는 post로
* 게시글 수정 기능 구현(post)
  * 컨트롤러에서 메소드 등록 및 코드 구현
    * 수정을 다하면 게시글 상세로 이동
    * 수정된 게시글 정보 확인
    * 로그인한 회원 정보 확인
    * 서비스에게 수정하라고 시킴
  * 서비스/서비스 임플에 메소드 등록 및 구현
    * 접속한 회원이 작성자인지 확인하여 일치하면 게시글 수정
  * 다오/매퍼에 메소드 등록 및 쿼리 구현
    * 수정된 게시글 정보를 DB에 업데이트



### 17. 게시글 삭제

* /board/delete
* 게시글 상세에서 삭제 버튼을 추가
  * 작성자만 보이도록 작업
  * 버튼을 클릭하면 삭제 링크로 이동하도록 작업
  * 수정버튼 참고
* 컨트롤러에서 메소드 등록 및 코드 구현
  * get방식으로 등록
  * 삭제를 다하면 /board/list로 이동
  * 삭제할 게시글 번호를 확인
  * 로그인한 회원을 확인
  * 서비스에게 삭제하라고 시킴
    * 필요한 매개변수 설정을 잘 해야함
* 서비스/서비스 임플에 메소드 등록 및 구현
  * 유효한 번호인지 확인
    * 유효하지 않으면 삭제 종료
  * 번호와 일치하는 게시글 가져옴
  * 게시글이 없으면 삭제 종료
  * 게시글이 있으면 게시글 작성자와 로그인한 회원 아이디가 같은지 확인
    * 같으면 게시글 삭제
    * 다오에게 해당 게시글의 bd_del 속성을 Y로 수정하라고 시킴
* 다오/매퍼에 메소드 등록및 쿼리를 구현
  * 다오에 메소드 등록 후 @Param
  * update 쿼리문 작성



### 18. 첨부파일 추가

* 기존 게시글에 첨부파일 등록하는 기능을 추가

  * 업로드를 위한 의존성 추가. pom.xml

    * ```xml
      <dependency>
          <groupId>commons-fileupload</groupId>
          <artifactId>commons-fileupload</artifactId>
          <version>1.3.2</version>
      </dependency>
      ```

  * servlet-context.xml에 업로드 크기 설정

    * ```xml
      <beans:bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
          <!-- 업로드 최대 크기 10Mb -->
          <beans:property name="maxUploadSize" value="10485760"></beans:property>
      </beans:bean>
      ```

  * 패키지 생성 및 UploadFileUtils 클래스 추가

    * 기본패키지명.utils 패키지 생성

    * ```java
      public class UploadFileUtils {
      	public static String uploadFile(String uploadPath, String originalName, byte[] 	
      			fileData)throws Exception{
      		UUID uid = UUID.randomUUID();
      		String savedName = uid.toString() +"_" + originalName;
      		String savedPath = calcPath(uploadPath);
      		File target = new File(uploadPath + savedPath, savedName);
      		FileCopyUtils.copy(fileData, target);
      		String uploadFileName = makeIcon(uploadPath, savedPath, savedName);
      		return uploadFileName;
      	}
      	
      	private static String calcPath(String uploadPath) {
      		Calendar cal = Calendar.getInstance();
      		
      		String yearPath = File.separator+cal.get(Calendar.YEAR);
      		String monthPath = yearPath + File.separator 
                  + new DecimalFormat("00").format(cal.get(Calendar.MONTH)+1);
      		String datePath = monthPath + File.separator 
                  + new DecimalFormat("00").format(cal.get(Calendar.DATE));
      		makeDir(uploadPath, yearPath, monthPath, datePath);
      		
      		return datePath;
       
      	}
      	private static void makeDir(String uploadPath, String... paths) {
      		if(new File(paths[paths.length-1]).exists())
      			return;
      		for(String path : paths) {
      			File dirPath = new File(uploadPath + path);
      			if( !dirPath.exists())
      				dirPath.mkdir();
      		}
      	}
      	private static String makeIcon(String uploadPath, String path, String fileName)
              	throws Exception{
      		String iconName = uploadPath + path + File.separator + fileName;
      		return iconName.substring(uploadPath.length()).replace(File.separatorChar, '/');
      	}
      }
      ```

      

1. 게시글 등록할 때 첨부파일 기능 추가

   * register.jsp에 form태그 속서으로 enctype을 추가하고 값을 설정

     * `enctype="multipart/form-data"`

     * ```html
       <form method="post" enctype="multipart/form-data">
           <!-- 화면 구현부는 생략 -->
       </form>
       ```

   * register.jsp에 첨부파일을 선택할 수 있도록, input태그를 추가

     * `<input type="file" name="xxx">`

     * ```html
       <div class="form-group">
           <label>첨부파일</label>
           <input type="file" class="form-control" name="files">
           <input type="file" class="form-control" name="files">
           <input type="file" class="form-control" name="files">
       </div>
       ```

   * 컨트롤러에서 첨부파일을 받을 수 있도록 매개변수를 추가

     * /board/regitser, post에 추가

     * ```java
       //이름은 register.jsp에 있는 name과 일치해야 함
       List<MutipartFile> files
       ```

   * 컨트롤러에서 서비스에게 시킨 게시글 등록 기능에 첨부파일을 추가

   * 서비스에 게시글 등록 메소드를 수정. 첨부파일을 매개변수로 추가

   * 서비스임플에 첨부파일을 매개변수로 추가

   * 게시글을 등록하고 나서 등록된 게시글의 게시글 번호를 가져오도록 xml수정

     * BoardMapper.xml에 다음 코드를 추가

     * ```xml
       <insert id="insertBoard" 
       	useGeneratedKeys="true"
           keyProperty="board.bd_num" 
           parameterType="kr.green.green.vo.BoardVO">
       ```

     * keyProperty

       * board : 다오에서 정한 이름. 다오에서 @Param("xxx") 이 부분에서 xxx에 해당
       * bd_num: VO의 기본키 이름

     * parameterType

       * 현재 진행중인 프로젝트의 패키지명과 VO명을 가져오면 됨.

   * 서비스 임플에 첨부파일 등록 기능

     * 반복문을 이용하여 첨부파일이 있으면 서버에 업로드하고, 다오에게 첨부파일을 등록하도록 시킴
     * 서비스임플에 첨부파일 경로를 멤버변수로 추가
       * 실제 폴더 경로
     * FileVO 생성
       * 테이블 속성 이름과 vo 멤버 변수 이름을 일치시켜야 함
       * 파일명, 경로파일명, 게시글 번호를 이용한 생성자 추가
       * 기본생성자 추가(@NoArgsConstructor)

   * 다오에 메소드 추가 및 매퍼에 쿼리문 추가

     * 매퍼에 insert문
     * 다오에 @Param 추가

2. 게시글 확인할 때 첨부파일 목록을 확인하고 클릭시 다운기능 추가

   * 컨트롤러에서 게시글 번호와 일치하는 첨부파일들을 가져오라고 서비스에게 시킴

     * /board/detail
     * 가져온 첨부파일들을 화면에 전송

   * 서비스/서비스 임플에 메소드 추가 및 구현

     * 게시글 번호가 유효하지 않으면 종료
     * 다오에게 게시글 번호와 일치하는 첨부파일을 가져오라고 시킴

   * 다오/매퍼에서 메소드 추가 및 쿼리문 구현

     * 매퍼에 select문
     * 다오에 @Param 추가

   * detail.jsp에 첨부파일 내용을 뿌려줌

     * a태그 이용
     * `<c:forEach></c:forEach>` 이용
     * 다운로드를 위해 링크 설정
       * /board/download

   * 컨트롤러에 다운로드를 위한 메소드 추가

     * 샘플 코드 참고

     * ```java
       @ResponseBody
       @RequestMapping("/board/download")
       public ResponseEntity<byte[]> downloadFile(String fileName)throws Exception{
       	InputStream in = null;
           ResponseEntity<byte[]> entity = null;
           String uploadPath = "D:\\JAVA_JIK\\upload";
           try{
           	String FormatName = fileName.substring(fileName.lastIndexOf(".")+1);
       	    HttpHeaders headers = new HttpHeaders();
           	in = new FileInputStream(uploadPath+fileName);
       
       		fileName = fileName.substring(fileName.indexOf("_")+1);
       		headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
       		headers.add("Content-Disposition",  "attachment; filename=\"" + new String(fileName.getBytes("UTF-8"), "ISO-8859-1")+"\"");
       	entity = new ResponseEntity<byte[]>	(IOUtils.toByteArray(in),headers,HttpStatus.CREATED);
       	}catch(Exception e) {
       		e.printStackTrace();
       		entity = new ResponseEntity<byte[]>(HttpStatus.BAD_REQUEST);
       	}finally {
       		in.close();
       	}
       	return entity;
       }
       ```

       

3. 게시글 수정할 때 첨부파일 수정 기능 추가

   * 컨트롤러에서 첨부파일을 가져옴
     * /board/modify, GET
     * 가져온 첨부파일을 화면에 전달
   * modify.jsp에서 서버에서 보내준 첨부파일을 뿌려줌
     * a태그 아님
     * x버튼을 만듬(a태그로)
       * 클릭하면 첨부파일 내용 사라지고, input태그 file 추가
     * 첨부파일 번호를 input태그 hidden로 추가
     * 남은 첨부파일 갯수만큼 input태그 file로 추가
   * modify.jsp에 enctyp을 설정
   * 컨트롤러에서 추가된 첨부파일과 기존 첨부파일 번호를 화면에서 받아옴
     * /board/modify, POST
     * 기존 첨부파일 번호들을 확인
   * 컨트롤러에서 서비스에게 첨부파일들과 첨부파일 번호들을 같이 넘겨주면서 수정하라고 시킴
   * 기존 서비스 메소드에 매개변수 추가
   * 기존 서비스 임플 메소드에 매개변수 추가 후 첨부파일 수정 코드 구현
     * fileNums에 없는 첨부파일들 삭제 후 DB에서 삭제처리
       * DB에 삭제처리를 위해 다오에게 삭제하라고 요청
   * 다오에 메소드 추가 및 매퍼에 쿼리문 구현
     * 다오에 @Param추가
     * 매퍼에 update문 추가
     * selectFileList에 조건 추가
       * 삭제되지 않은 첨부파일만 가져오도록 수정
   * 서비스 임플에서 새로 추가된 첨부파일 등록

4. 게시글 삭제할 때 첨부파일 삭제 기능 추가



### 에러가 나는 경우

1. 에러 내용에 다음이 들어간 경우

   * ```java
     Error creating bean with name 'homeController': Unsatisfied dependency expressed through field 'memberService';
     ```

   * 경우1 : MemberServiceImp에 @Service를 빼먹은 경우
   * 경우2 : servlet-context.xml에 base-package를 잘못 설정한 경우

2. 에러 내용에 다음이 들어간 경우

   * ```java
     Error creating bean with name 'memberServiceImp': Unsatisfied dependency expressed through field 'memberDao'
     ```

   * 경우1 : root-context.xml에 mybatis-spring:scan base-package를 잘못 설정한 경우

   * 경우2 : MemberDAO를 클래스로 만든 경우

3. 에러 내용에 다음이 들어간 경우

   * ```java
     Invalid bound statement (not found): kr.green.green.dao.MemberDAO.test
     ```

   * 경우1 : MemberMapper.xml에 namespace에 오타가 있는 경우

   * 경우2 : MemberMapper.xml에 id에 오타가 있는 경우

   * 경우3 : mappers 폴더의 위치가 잘못된 경우

4. 에러 내용에 다음이 들어간 경우

   * ```java
     Could not resolve type alias 'kr.green.green.vo.MemberVO2'.  Cause: java.lang.ClassNotFoundException: Cannot find class: kr.green.green.vo.MemberVO2
     ```

   * 경우 : MemberMapper.xml에 resultType에 오타가 있는 경우

5. xml 파일과 관련된 에러 발생후 올바르게 수정했는데 계속 에러나는 경우

   * 원인 : 수정된 내용이 반영이 제대로 안되서
   * 해결방안 : 프로젝트 선택 후 Alt + F5를 누름

6. 에러 내용에 다음이 들어간 경우

   * ```java
     Could not resolve resource location pattern [classpath:mappers/**/*Mapper.xml]: class path resource [mappers/] cannot be resolved to URL because it does not exist
     ```

   * 경우 : mappers 폴더 위치가 src/main/resources가 아니거나 폴더이름에 오타가 있는 경우

7. 404 에러 중 콘솔 창에 다음 경고가 뜨는 경우

   * ```java
     WARN : org.springframework.web.servlet.PageNotFound - No mapping for GET /green/login
     ```

   * 경우1 : 컨트롤러에 URL을 담당하는 메소드를 만들지 않은 경우

   * 경우2 : 새 컨트롤러에 메소드를 제대로 만들었지만 컨트롤러 위에 @Controller를 안한 경우

8. 405 에러 중 콘솔 창에 다음 경고가 뜨는 경우

   * ```java
     Request method 'POST' not supported
     ```

   * 경우 : 컨트롤러에 URL 중 POST를 담당하는 메소드를 만들지 않은 경우

